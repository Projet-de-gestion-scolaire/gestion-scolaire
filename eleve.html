<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion des √âl√®ves</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <style>
    /* D√©finitions des couleurs personnalis√©es en CSS pur */
    /* Celles-ci doivent correspondre aux classes Tailwind que vous utilisez */
    .bg-primary-blue {
      background-color: #0F172A;
    }

    .text-primary-blue {
      color: #0F172A;
    }

    .bg-accent-blue {
      background-color: #2563EB;
    }

    .hover\:bg-accent-blue:hover {
      background-color: #2563EB;
    }

    /* Assure la couleur de survol */
    .bg-accent-blue-dark {
      background-color: #1D4ED8;
    }

    /* Pour les √©tats 'dark' des boutons par exemple */
    .hover\:bg-accent-blue-dark:hover {
      background-color: #1D4ED8;
    }

    .bg-accent-green {
      background-color: #10B981;
    }

    .hover\:bg-accent-green-dark:hover {
      background-color: #059669;
    }

    .bg-accent-yellow {
      background-color: #FBBF24;
    }

    .hover\:bg-accent-yellow-dark:hover {
      background-color: #F59E0B;
    }

    .bg-accent-red {
      background-color: #EF4444;
    }

    .hover\:bg-accent-red-dark:hover {
      background-color: #DC2626;
    }

    .bg-accent-cyan {
      background-color: #06B6D4;
    }

    .hover\:bg-accent-cyan-dark:hover {
      background-color: #0891B2;
    }

    .bg-accent-purple {
      background-color: #8B5CF6;
    }

    .hover\:bg-accent-purple-dark:hover {
      background-color: #7C3AED;
    }

    .bg-accent-orange {
      background-color: #F97316;
    }

    .hover\:bg-accent-orange-dark:hover {
      background-color: #EA580C;
    }


    /* Styles pour les √©l√©ments du menu lat√©ral (SIDEBAR) */
    /* Cible les liens du menu non actifs */
    #main-sidebar nav a:not(.bg-accent-blue) {
      /* Styles par d√©faut pour les liens non survol√©s et non actifs */
      color: #4B5563;
      /* text-gray-700 */
      font-weight: 600;
      /* font-semibold */
    }

    /* Styles de survol pour les liens du menu (pour le texte et les ic√¥nes) */
    /* Note: Tailwind utilise `group` sur le parent et `group-hover:text-white` sur l'enfant. */
    /* Il faut donc cibler l'enfant lorsque le parent est en √©tat de survol. */
    /* Ici, le `hover:bg-accent-blue` est d√©j√† sur le <a> parent, donc on s'assure que le texte devient blanc */
    #main-sidebar nav a.group:hover span.group-hover\:text-white {
      color: white !important;
      /* Force le texte √† devenir blanc au survol */
    }

    /* Et pour les ic√¥nes (text-gray-600 par d√©faut) */
    #main-sidebar nav a.group:hover span.text-gray-600 {
      color: white !important;
      /* Force les ic√¥nes √† devenir blanches au survol */
    }

    /* Styles pour le header au d√©filement */
    .scrolled-header {
      background-color: #0F172A;
      color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }

    .scrolled-header .text-primary-blue {
      color: white;
    }

    .scrolled-header .text-gray-600 {
      color: white;
    }

    .scrolled-header .text-gray-700 {
      color: white;
    }

    .scrolled-header .hover\:text-accent-blue:hover {
      color: #DBEAFE;
    }

    .scrolled-header .hover\:text-accent-cyan:hover {
      color: #67E8F9;
    }

    .scrolled-header .hover\:text-accent-green:hover {
      color: #86EFAC;
    }

    /* Styles pour la barre lat√©rale sur mobile */
    #main-sidebar.active {
      transform: translateX(0);
    }

    #sidebar-overlay.active {
      opacity: 0.5;
      display: block;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans">

  <header id="main-header"
    class="bg-white shadow fixed top-0 left-0 right-0 z-50 flex items-center justify-between py-2 px-4 transition-all duration-300 ease-in-out">
    <div class="flex items-center space-x-4">
      <img src="logo.png" alt="Logo √©cole" class="w-12 h-12 object-contain" />
      <h1 class="text-xl font-bold text-primary-blue">Gestion Administrative</h1>
    </div>

    <button id="menu-toggle" class="md:hidden text-gray-600 hover:text-accent-blue focus:outline-none">
      <i class="fas fa-bars text-xl"></i>
    </button>

    <div class="flex items-center space-x-4">
      <a href="#" class="relative text-gray-600 hover:text-accent-cyan"><i class="fas fa-bell text-xl"></i>
        <span
          class="absolute -top-2 -right-2 text-xs bg-accent-red text-white rounded-full w-5 h-5 flex items-center justify-center">3</span>
      </a>
      <div class="relative">
        <button id="user-toggle"
          class="flex items-center space-x-1 text-gray-700 hover:text-accent-green focus:outline-none">
          <i class="fas fa-user-circle text-2xl"></i><span>N√®n√® Diallo</span><i class="fas fa-caret-down text-sm"></i>
        </button>
        <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg z-50">
          <a href="#" class="block px-4 py-2 text-sm hover:bg-green-100">Profil</a>
          <a href="#" class="block px-4 py-2 text-sm hover:bg-green-100">D√©connexion</a>
        </div>
      </div>
      <a href="parametres.html" class="text-gray-600 hover:text-primary-blue"><i class="fas fa-cog text-xl"></i></a>
    </div>
  </header>

  <div class="flex max-w-7xl mx-auto pt-24 px-4 gap-6">
    <aside id="main-sidebar" class="bg-white w-64 min-h-screen p-4 shadow-md
                    fixed top-0 left-0 h-full transform -translate-x-full md:relative md:translate-x-0 md:block
                    transition-transform duration-300 ease-in-out z-40">
      <h2 class="text-xl font-semibold mb-4 text-primary-blue">Tableau de bord - Menu</h2>
      <nav class="space-y-2">
        <a href="index.html"
          class="flex items-center py-2 px-4 rounded transition-colors duration-200 group hover:bg-accent-blue">
          <span class="text-xl mr-3 text-gray-600 group-hover:text-white">üè†</span>
          <span class="hidden md:inline font-semibold text-gray-700 group-hover:text-white">Accueil</span>
        </a>

        <a href="eleves.html" class="flex items-center py-2 px-4 rounded bg-accent-blue text-white font-semibold">
          <span class="text-xl mr-3 text-white">üë®‚Äçüéì</span>
          <span class="hidden md:inline text-white">√âl√®ves</span>
        </a>

        <a href="classes.html"
          class="flex items-center py-2 px-4 rounded transition-colors duration-200 group hover:bg-accent-blue">
          <span class="text-xl mr-3 text-gray-600 group-hover:text-white">üìö</span>
          <span class="hidden md:inline font-semibold text-gray-700 group-hover:text-white">Classes & Mati√®res</span>
        </a>

        <a href="emploi.html"
          class="flex items-center py-2 px-4 rounded transition-colors duration-200 group hover:bg-accent-blue">
          <span class="text-xl mr-3 text-gray-600 group-hover:text-white">üìÖ</span>
          <span class="hidden md:inline font-semibold text-gray-700 group-hover:text-white">Emploi du temps</span>
        </a>

        <a href="professeur.html"
          class="flex items-center py-2 px-4 rounded transition-colors duration-200 group hover:bg-accent-blue">
          <span class="text-xl mr-3 text-gray-600 group-hover:text-white">üë®‚Äçüè´</span>
          <span class="hidden md:inline font-semibold text-gray-700 group-hover:text-white">Professeurs</span>
        </a>

        <a href="notification.html"
          class="flex items-center py-2 px-4 rounded transition-colors duration-200 group hover:bg-accent-blue">
          <span class="text-xl mr-3 text-gray-600 group-hover:text-white">üîî</span>
          <span class="hidden md:inline font-semibold text-gray-700 group-hover:text-white">Notifications</span>
        </a>

        <a href="parametres.html"
          class="flex items-center py-2 px-4 rounded transition-colors duration-200 group hover:bg-accent-blue">
          <span class="text-xl mr-3 text-gray-600 group-hover:text-white">‚öô</span>
          <span class="hidden md:inline font-semibold text-gray-700 group-hover:text-white">Param√®tres</span>
        </a>
      </nav>
    </aside>

    <main class="flex-1">
      <h2 class="text-2xl font-bold mb-4 text-primary-blue">Gestion des √âl√®ves</h2>

      <div class="mb-4 flex gap-4 flex-wrap">
        <button id="btn-ajouter"
          class="bg-accent-yellow hover:bg-accent-yellow-dark text-white font-semibold px-4 py-2 rounded shadow-md">
          ‚ûï Ajouter ou modifier un √©l√®ve
        </button>
        <button id="btn-ajouter-notes"
          class="bg-accent-blue hover:bg-accent-blue-dark text-white font-semibold px-4 py-2 rounded shadow-md">
          üìù Ajouter des notes d‚Äô√©valuation
        </button>
        <button id="btn-enregistrer-presences"
          class="bg-accent-cyan hover:bg-accent-cyan-dark text-white font-semibold px-4 py-2 rounded shadow-md">
          ‚úÖ Enregistrer les pr√©sences
        </button>
        <button id="btn-suivre-devoirs"
          class="bg-accent-purple hover:bg-accent-purple-dark text-white font-semibold px-4 py-2 rounded shadow-md">
          üìö Suivre les devoirs
        </button>
        <button id="btn-gerer-scolarite"
          class="bg-accent-orange hover:bg-accent-orange-dark text-white font-semibold px-4 py-2 rounded shadow-md">
          üí∏ G√©rer la scolarit√©
        </button>
      </div>

      <div id="formulaire-eleve" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden border border-gray-200">
        <h3 id="form-titre" class="text-lg font-semibold mb-4 text-primary-blue">Ajouter ou modifier un √©l√®ve</h3>
        <form id="form-eleve" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <input type="text" id="nom" placeholder="Nom complet" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <select type="text" id="sexe" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue">
            <option value="">S√©lectionner le sexe</option>
            <option value="M">Masculin</option>
            <option value="F">F√©minin</option>
          </select>
          <input type="date" id="naissance" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <input type="text" id="filiation" placeholder="Filiation (Nom du p√®re et de la m√®re)" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <input type="text" id="matricule" placeholder="Matricule (4 chiffres)" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue"
            pattern="\d{4}" title="Le matricule doit contenir 4 chiffres." />
          <select id="classe" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue"></select>
          <select id="statut" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue">
            <option value="present">Pr√©sent</option>
            <option value="absent">Absent</option>
          </select>

          <div class="col-span-full">
            <h4 class="text-md font-semibold mt-4 mb-2 text-primary-blue">Informations Compl√©mentaires</h4>
          </div>
          <input type="date" id="dateInscription" placeholder="Date d'inscription"
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <input type="text" id="adresse" placeholder="Adresse compl√®te"
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <input type="tel" id="telephone" placeholder="T√©l√©phone (ex: +224 620 00 00 00)"
            pattern="^\+?[0-9\s\-\(\)]{8,20}$" title="Veuillez entrer un num√©ro de t√©l√©phone valide."
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <input type="email" id="email" placeholder="Adresse email"
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />

          <div class="col-span-full">
            <label for="photoEleve" class="block text-sm font-medium text-gray-700 mb-1">Photo de l'√©l√®ve</label>
            <input type="file" id="photoEleve" accept="image/*"
              class="border border-gray-300 rounded px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-accent-blue" />
            <img id="previewPhoto" class="mt-2 hidden w-32 h-32 object-cover rounded-full border-2 border-gray-300"
              alt="Aper√ßu photo" />
          </div>


          <div class="md:col-span-2 lg:col-span-3 flex gap-4 mt-4">
            <button type="submit"
              class="bg-accent-green hover:bg-accent-green-dark text-white px-6 py-2 rounded w-full shadow-md">Enregistrer</button>
            <button type="button" id="btn-annuler"
              class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded w-full shadow-md">Annuler</button>
          </div>
        </form>
      </div>

      <div class="bg-white p-4 rounded-lg shadow-lg mb-6 border border-gray-200">
        <h4 class="text-lg font-semibold mb-4 text-primary-blue">üîç Rechercher un √©l√®ve</h4>
        <div class="flex flex-wrap gap-4 items-end">
          <input type="text" id="search-eleves" placeholder="Nom, matricule..."
            class="border border-gray-300 rounded px-4 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-accent-blue" />

          <select id="filter-classe"
            class="border border-gray-300 rounded px-4 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-accent-blue">
            <option value="">Toutes les classes</option>
          </select>

          <select id="filter-statut"
            class="border border-gray-300 rounded px-4 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-accent-blue">
            <option value="">Tous les statuts</option>
            <option value="present">Pr√©sent</option>
            <option value="absent">Absent</option>
          </select>
          <select id="filter-sexe"
            class="border border-gray-300 rounded px-4 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-accent-blue">
            <option value="">Tous les sexes</option>
            <option value="M">Masculin</option>
            <option value="F">F√©minin</option>
          </select>

          <button id="btn-reset-filtres"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded shadow-md">
            üîÑ R√©initialiser les filtres
          </button>
        </div>
      </div>

      <div id="form-notes" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden border border-gray-200">
        <h3 class="text-lg font-semibold mb-4 text-primary-blue">Ajouter des notes d‚Äô√©valuation</h3>
        <form id="notes-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <input type="text" id="note-matricule" placeholder="Matricule de l‚Äô√©l√®ve" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <input type="text" id="periode-evaluation"
            placeholder="P√©riode ou type d'√©valuation (ex: Trimestre 1, Devoir 2)" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <input type="date" id="date-evaluation" placeholder="Date de l'√©valuation" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />

          <div id="champs-notes-dynamiques"
            class="md:col-span-3 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          </div>
          <div class="md:col-span-3 lg:col-span-3 flex gap-4">
            <button type="submit"
              class="bg-accent-green hover:bg-accent-green-dark text-white px-6 py-2 rounded w-full shadow-md">
              Enregistrer les notes
            </button>
            <button type="button" id="btn-annuler-notes"
              class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded w-full shadow-md">
              Annuler
            </button>
          </div>
        </form>
      </div>

      <div id="form-presences" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden border border-gray-200">
        <h3 class="text-lg font-semibold mb-4 text-primary-blue">Enregistrer les Pr√©sences</h3>
        <form id="presences-form">
          <div class="mb-4">
            <label for="date-presence" class="block text-sm font-medium text-gray-700 mb-1">Date de la pr√©sence
              :</label>
            <input type="date" id="date-presence" required
              class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue w-full md:w-1/2" />
          </div>
          <div class="mb-4">
            <label for="filter-classe-presence" class="block text-sm font-medium text-gray-700 mb-1">Filtrer par classe
              :</label>
            <select id="filter-classe-presence"
              class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue w-full md:w-1/2">
              <option value="">Toutes les classes</option>
            </select>
          </div>
          <div id="liste-eleves-presences" class="space-y-3 mb-6">
            <p class="text-gray-500">S√©lectionnez une date pour charger les √©l√®ves.</p>
          </div>
          <div class="flex gap-4 mt-4">
            <button type="submit"
              class="bg-accent-green hover:bg-accent-green-dark text-white px-6 py-2 rounded w-full shadow-md">
              Enregistrer les pr√©sences
            </button>
            <button type="button" id="btn-annuler-presences"
              class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded w-full shadow-md">
              Annuler
            </button>
          </div>
        </form>
      </div>

      <div id="form-devoirs" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden border border-gray-200">
        <h3 class="text-lg font-semibold mb-4 text-primary-blue">Suivi des devoirs</h3>
        <form id="devoirs-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="devoir-matricule" placeholder="Matricule de l‚Äô√©l√®ve" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <select id="devoir-matiere" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue">
            <option value="">S√©lectionner la mati√®re</option>
          </select>
          <input type="text" id="devoir-description" placeholder="Description du devoir (ex: Exercices p.10)" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue col-span-full" />
          <label for="devoir-date-assignation" class="block text-sm font-medium text-gray-700">Date
            d'assignation:</label>
          <input type="date" id="devoir-date-assignation" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <label for="devoir-date-remise" class="block text-sm font-medium text-gray-700">Date de remise
            (effective):</label>
          <input type="date" id="devoir-date-remise"
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <select id="devoir-statut" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue col-span-full">
            <option value="">Statut du devoir</option>
            <option value="fait">Fait</option>
            <option value="non fait">Non fait</option>
            <option value="en retard">En retard</option>
          </select>
          <div class="col-span-full flex gap-4 mt-4">
            <button type="submit"
              class="bg-accent-green hover:bg-accent-green-dark text-white px-6 py-2 rounded w-full shadow-md">
              Enregistrer le devoir
            </button>
            <button type="button" id="btn-annuler-devoirs"
              class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded w-full shadow-md">
              Annuler
            </button>
          </div>
        </form>
      </div>

      <div id="form-scolarite" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden border border-gray-200">
        <h3 class="text-lg font-semibold mb-4 text-primary-blue">Gestion des frais de scolarit√©</h3>
        <form id="scolarite-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="scolarite-matricule" placeholder="Matricule de l‚Äô√©l√®ve" required
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />

          <div class="col-span-full mb-4 p-3 bg-gray-50 rounded-md">
            <label for="scolarite-total-du" class="block text-sm font-medium text-gray-700 mb-1">Montant total des frais
              de scolarit√© d√ª (Ann√©e):</label>
            <input type="number" id="scolarite-total-du" placeholder="Montant total d√ª" min="0" step="any"
              class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue w-full" />
          </div>

          <h4 class="col-span-full text-md font-semibold mb-2 text-primary-blue">Enregistrer un nouveau paiement</h4>
          <label for="scolarite-date-paiement" class="block text-sm font-medium text-gray-700">Date du paiement:</label>
          <input type="date" id="scolarite-date-paiement"
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <label for="scolarite-montant-paiement" class="block text-sm font-medium text-gray-700">Montant pay√©:</label>
          <input type="number" id="scolarite-montant-paiement" placeholder="Montant du paiement" min="0" step="any"
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
          <input type="text" id="scolarite-description-paiement" placeholder="Description (ex: 1er acompte, Solde T1)"
            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue col-span-full" />

          <div class="col-span-full flex gap-4 mt-4">
            <button type="submit"
              class="bg-accent-green hover:bg-accent-green-dark text-white px-6 py-2 rounded w-full shadow-md">
              Enregistrer les frais
            </button>
            <button type="button" id="btn-annuler-scolarite"
              class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded w-full shadow-md">
              Annuler
            </button>
          </div>
        </form>
      </div>


      <div id="message-box" class="hidden mb-4 px-4 py-3 rounded text-sm font-medium"></div>

      <h3 class="text-lg font-semibold mb-2 text-primary-blue">üìã Liste des √©l√®ves</h3>
      <div class="overflow-auto shadow-lg rounded-lg border border-gray-200">
        <table id="table-eleves" class="min-w-full bg-white">
          <thead class="bg-accent-blue text-white">
            <tr>
              <th class="py-3 px-4 text-left">N¬∞</th>
              <th class="py-3 px-4 text-left">Nom</th>
              <th class="py-3 px-4 text-left">Sexe</th>
              <th class="py-3 px-4 text-left">Naissance</th>
              <th class="py-3 px-4 text-left">Filiation</th>
              <th class="py-3 px-4 text-left">Matricule</th>
              <th class="py-3 px-4 text-left">Classe</th>
              <th class="py-3 px-4 text-left">Statut</th>
              <th class="py-3 px-4 text-left">Actions</th>
            </tr>
          </thead>
          <tbody class="text-gray-700"></tbody>
        </table>
      </div>
    </main>
  </div>

  <div id="fiche-eleve" class="bg-white shadow-lg rounded p-4 mt-6 hidden border border-gray-200 max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold text-primary-blue">üë§ Fiche de l‚Äô√©l√®ve</h3>
      <button id="btn-fermer-fiche" class="text-accent-red hover:text-accent-red-dark font-semibold text-lg">
        ‚úñ Fermer
      </button>
    </div>
    <div id="fiche-contenu" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-800">
    </div>
  </div>

  <div id="sidebar-overlay"
    class="fixed inset-0 bg-black opacity-0 z-30 hidden transition-opacity duration-300 ease-in-out"></div>

  <footer class="mt-10 bg-primary-blue text-white text-center py-4 text-sm">
    <p>&copy; 2025 √âcole X - Tous droits r√©serv√©s</p>
  </footer>

  <script>
    // R√©f√©rences aux √©l√©ments du DOM
    const formEl = document.getElementById("formulaire-eleve");
    const form = document.getElementById("form-eleve");
    const notesFormEl = document.getElementById("form-notes");
    const notesForm = document.getElementById("notes-form");
    const presencesFormEl = document.getElementById("form-presences");
    const presencesForm = document.getElementById("presences-form");
    const devoirsFormEl = document.getElementById("form-devoirs"); // Nouveau
    const devoirsForm = document.getElementById("devoirs-form"); // Nouveau
    const scolariteFormEl = document.getElementById("form-scolarite"); // Nouveau
    const scolariteForm = document.getElementById("scolarite-form"); // Nouveau

    const ficheEl = document.getElementById("fiche-eleve");
    const ficheContenu = document.getElementById("fiche-contenu");
    const messageBox = document.getElementById("message-box");
    const tbody = document.querySelector("#table-eleves tbody");
    const champsNotesDynamiques = document.getElementById("champs-notes-dynamiques");
    const listeElevesPresences = document.getElementById("liste-eleves-presences");
    const devoirMatiereSelect = document.getElementById("devoir-matiere"); // Nouveau
    const scolariteMatriculeInput = document.getElementById("scolarite-matricule"); // Nouveau
    const scolariteTotalDuInput = document.getElementById("scolarite-total-du"); // Nouveau


    const photoInput = document.getElementById("photoEleve");
    const previewPhoto = document.getElementById("previewPhoto");

    const menuToggle = document.getElementById("menu-toggle");
    const mainSidebar = document.getElementById("main-sidebar");
    const sidebarOverlay = document.getElementById("sidebar-overlay");
    const userToggle = document.getElementById("user-toggle");
    const userDropdown = document.getElementById("user-dropdown");
    const mainHeader = document.getElementById("main-header");


    let editIndex = null;

    // Helpers stockage (COMMUNS - Ces fonctions sont n√©cessaires dans toutes les pages qui les utilisent)
    const getEleves = () => JSON.parse(localStorage.getItem("eleves") || "[]");
    const setEleves = data => localStorage.setItem("eleves", JSON.stringify(data));
    const getClasses = () => JSON.parse(localStorage.getItem("classes") || "[]");
    const getMatieres = () => JSON.parse(localStorage.getItem("matieres") || '["Fran√ßais", "Math√©matiques", "Physique"]');

    const normalize = str => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

    // Fonction pour g√©rer la pr√©visualisation de la photo
    photoInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewPhoto.src = e.target.result;
          previewPhoto.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        previewPhoto.src = '';
        previewPhoto.classList.add('hidden');
      }
    });

    // Formulaires : soumission √©l√®ve (MISE √Ä JOUR pour initialiser historiqueNotes, attendanceRecords, homeworks, payments)
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const eleves = getEleves();

      const data = {
        nom: form.nom.value.trim(),
        sexe: form.sexe.value.trim(),
        dateNaissance: form.naissance.value,
        filiation: form.filiation.value.trim(),
        matricule: form.matricule.value.trim().padStart(4, '0'),
        classe: form.classe.value.trim(),
        statut: form.statut.value,
        dateInscription: form.dateInscription.value,
        adresse: form.adresse.value.trim(),
        telephone: form.telephone.value.trim(),
        email: form.email.value.trim(),
        photo: '',
        historiqueNotes: [],
        attendanceRecords: [],
        homeworks: [], // NOUVEAU: Initialisation pour les devoirs
        totalFeesDue: 0, // NOUVEAU: Montant total des frais
        balanceDue: 0,   // NOUVEAU: Solde restant d√ª
        payments: []     // NOUVEAU: Historique des paiements
      };

      if (photoInput.files.length > 0) {
        const file = photoInput.files[0];
        data.photo = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(file);
        });
      } else if (editIndex !== null && eleves[editIndex].photo) {
        data.photo = eleves[editIndex].photo;
      }


      if (Object.values(data).slice(0, 7).some(v => !v)) return show("Veuillez remplir les champs obligatoires (Nom, Sexe, Naissance, Filiation, Matricule, Classe, Statut)", "red");
      if (!/^\d{4}$/.test(data.matricule)) return show("Matricule invalide (doit √™tre 4 chiffres)", "red");

      const existingEleve = eleves.find(e => e.matricule === data.matricule);
      if (editIndex !== null) {
        if (existingEleve && eleves.indexOf(existingEleve) !== editIndex) {
          return show("Matricule d√©j√† utilis√© par un autre √©l√®ve", "red");
        }
        // Lors de la modification, conserver tous les historiques et donn√©es financi√®res
        data.historiqueNotes = eleves[editIndex].historiqueNotes || [];
        data.attendanceRecords = eleves[editIndex].attendanceRecords || [];
        data.homeworks = eleves[editIndex].homeworks || [];
        data.totalFeesDue = eleves[editIndex].totalFeesDue || 0;
        data.balanceDue = eleves[editIndex].balanceDue || 0;
        data.payments = eleves[editIndex].payments || [];

        eleves.splice(editIndex, 1, data);
        show("√âl√®ve modifi√©", "green");
      } else {
        if (existingEleve) {
          return show("Matricule d√©j√† utilis√© par un autre √©l√®ve", "red");
        }
        eleves.push(data);
        show("√âl√®ve ajout√©", "green");
      }
      setEleves(eleves);
      form.reset();
      photoInput.value = '';
      previewPhoto.classList.add('hidden');
      formEl.classList.add("hidden");
      editIndex = null;
      render();
    });

    // Formulaire notes
    notesForm.addEventListener("submit", e => {
      e.preventDefault();
      const matricule = notesForm["note-matricule"].value.trim();
      const periode = notesForm["periode-evaluation"].value.trim();
      const dateEvaluation = notesForm["date-evaluation"].value;

      if (!periode || !dateEvaluation) {
        return show("Veuillez renseigner la p√©riode et la date de l'√©valuation", "red");
      }

      const eleves = getEleves();
      const eleve = eleves.find(e => e.matricule === matricule);

      if (!eleve) return show("Matricule non trouv√©", "red");

      const matieres = getMatieres();
      const notesMatiere = {};
      let totalNotes = 0;
      let countNotes = 0;

      matieres.forEach(matiere => {
        const inputId = `note-${normalize(matiere)}`;
        const noteInput = document.getElementById(inputId);
        const noteValue = noteInput ? parseFloat(noteInput.value) : NaN;

        if (!isNaN(noteValue) && noteValue >= 0 && noteValue <= 20) {
          notesMatiere[normalize(matiere)] = noteValue;
          totalNotes += noteValue;
          countNotes++;
        }
      });

      if (countNotes === 0) {
        return show("Veuillez saisir au moins une note valide.", "red");
      }

      const moyennePeriode = totalNotes / countNotes;

      eleve.historiqueNotes = eleve.historiqueNotes || [];
      eleve.historiqueNotes.push({
        periode: periode,
        dateEvaluation: dateEvaluation,
        notesMatiere: notesMatiere,
        moyennePeriode: moyennePeriode
      });

      setEleves(eleves);
      notesForm.reset();
      notesFormEl.classList.add("hidden");
      show("Notes enregistr√©es pour l'√©valuation " + periode, "green");
      render();
      ficheEl.classList.add("hidden");
    });

    // Formulaire de pr√©sences
    presencesForm.addEventListener("submit", e => {
      e.preventDefault();
      const datePresence = presencesForm["date-presence"].value;
      if (!datePresence) {
        return show("Veuillez s√©lectionner une date de pr√©sence.", "red");
      }

      const eleves = getEleves();
      let updatedCount = 0;

      eleves.forEach(eleve => {
        const eleveCheckbox = document.getElementById(`presence-${eleve.matricule}`);
        if (!eleveCheckbox) return;

        const status = document.querySelector(`input[name="status-${eleve.matricule}"]:checked`)?.value;

        if (status) {
          eleve.attendanceRecords = eleve.attendanceRecords || [];

          const existingRecordIndex = eleve.attendanceRecords.findIndex(record => record.date === datePresence);

          if (existingRecordIndex !== -1) {
            eleve.attendanceRecords[existingRecordIndex].status = status;
          } else {
            eleve.attendanceRecords.push({ date: datePresence, status: status });
          }
          updatedCount++;
        }
      });

      if (updatedCount === 0) {
        return show("Aucune pr√©sence n'a √©t√© enregistr√©e ou modifi√©e. V√©rifiez que des √©l√®ves sont affich√©s.", "red");
      }

      setEleves(eleves);
      presencesForm.reset();
      presencesFormEl.classList.add("hidden");
      show(`${updatedCount} pr√©sences enregistr√©es pour le ${datePresence}`, "green");
      render();
    });

    // NOUVEAU: Formulaire de suivi des devoirs
    devoirsForm.addEventListener("submit", e => {
      e.preventDefault();
      const matricule = devoirsForm["devoir-matricule"].value.trim();
      const matiere = devoirsForm["devoir-matiere"].value.trim();
      const description = devoirsForm["devoir-description"].value.trim();
      const dateAssignation = devoirsForm["devoir-date-assignation"].value;
      const dateRemise = devoirsForm["devoir-date-remise"].value;
      const statut = devoirsForm["devoir-statut"].value;

      if (!matricule || !matiere || !description || !dateAssignation || !statut) {
        return show("Veuillez remplir tous les champs obligatoires du devoir.", "red");
      }

      const eleves = getEleves();
      const eleve = eleves.find(e => e.matricule === matricule);

      if (!eleve) return show("Matricule non trouv√© pour le devoir", "red");

      eleve.homeworks = eleve.homeworks || [];
      eleve.homeworks.push({
        matiere: matiere,
        description: description,
        dateAssignation: dateAssignation,
        dateRemise: dateRemise || null, // Peut √™tre vide si non remis
        statut: statut,
        id: Date.now() // Un ID unique pour faciliter la modification/suppression future
      });

      setEleves(eleves);
      devoirsForm.reset();
      devoirsFormEl.classList.add("hidden");
      show("Devoir enregistr√© pour " + eleve.nom, "green");
      render();
      ficheEl.classList.add("hidden");
    });

    // NOUVEAU: Formulaire de gestion des frais de scolarit√©
    scolariteForm.addEventListener("submit", e => {
      e.preventDefault();
      const matricule = scolariteForm["scolarite-matricule"].value.trim();
      const totalFeesDue = parseFloat(scolariteForm["scolarite-total-du"].value);
      const datePaiement = scolariteForm["scolarite-date-paiement"].value;
      const montantPaiement = parseFloat(scolariteForm["scolarite-montant-paiement"].value);
      const descriptionPaiement = scolariteForm["scolarite-description-paiement"].value.trim();

      if (!matricule) {
        return show("Veuillez renseigner le matricule de l'√©l√®ve.", "red");
      }

      const eleves = getEleves();
      const eleve = eleves.find(e => e.matricule === matricule);

      if (!eleve) return show("Matricule non trouv√© pour la scolarit√©", "red");

      // Mettre √† jour le montant total d√ª si renseign√©
      if (!isNaN(totalFeesDue) && totalFeesDue >= 0) {
        eleve.totalFeesDue = totalFeesDue;
      }

      // Enregistrer un nouveau paiement si les champs sont remplis
      if (datePaiement && !isNaN(montantPaiement) && montantPaiement > 0) {
        eleve.payments = eleve.payments || [];
        eleve.payments.push({
          date: datePaiement,
          montant: montantPaiement,
          description: descriptionPaiement,
          id: Date.now()
        });
        show(`Paiement de ${montantPaiement} enregistr√© pour ${eleve.nom}`, "green");
      } else if (isNaN(totalFeesDue) && (!datePaiement || isNaN(montantPaiement) || montantPaiement <= 0)) {
        // Si ni le total d√ª n'est mis √† jour, ni un paiement valide n'est enregistr√©
        return show("Veuillez soit d√©finir un montant total d√ª, soit enregistrer un paiement valide (date et montant).", "red");
      } else if (!isNaN(totalFeesDue) && totalFeesDue >= 0) {
        show(`Montant total d√ª mis √† jour √† ${totalFeesDue} pour ${eleve.nom}`, "green");
      }

      // Recalculer le solde d√ª
      const totalPaid = eleve.payments.reduce((sum, p) => sum + p.montant, 0);
      eleve.balanceDue = eleve.totalFeesDue - totalPaid;

      setEleves(eleves);
      scolariteForm.reset();
      scolariteFormEl.classList.add("hidden");
      // R√©initialiser les champs sp√©cifiques du formulaire pour une nouvelle saisie ou modification
      scolariteMatriculeInput.value = "";
      scolariteTotalDuInput.value = "";
      render();
      ficheEl.classList.add("hidden");
    });

    // NOUVEAU: Charger les √©l√®ves dans le formulaire de pr√©sence
    function populateAttendanceFormElements() {
      const datePresence = document.getElementById("date-presence").value;
      const filterClasse = document.getElementById("filter-classe-presence").value;
      const eleves = getEleves();
      listeElevesPresences.innerHTML = '';

      if (!datePresence) {
        listeElevesPresences.innerHTML = '<p class="text-gray-500">S√©lectionnez une date pour charger les √©l√®ves.</p>';
        presencesForm.querySelector('button[type="submit"]').disabled = true;
        return;
      }
      presencesForm.querySelector('button[type="submit"]').disabled = false;

      const filteredEleves = eleves.filter(e =>
        (!filterClasse || normalize(e.classe) === normalize(filterClasse))
      ).sort((a, b) => a.nom.localeCompare(b.nom));

      if (filteredEleves.length === 0) {
        listeElevesPresences.innerHTML = '<p class="text-gray-500">Aucun √©l√®ve trouv√© pour cette classe ou date.</p>';
        return;
      }

      filteredEleves.forEach(eleve => {
        const existingRecord = eleve.attendanceRecords?.find(record => record.date === datePresence);
        const currentStatus = existingRecord ? existingRecord.status : 'absent';

        listeElevesPresences.innerHTML += `
                    <div class="flex items-center space-x-4 border-b border-gray-100 py-2">
                        <input type="hidden" name="matricule-${eleve.matricule}" value="${eleve.matricule}" id="presence-${eleve.matricule}" />
                        <div class="w-1/2 md:w-1/3 text-gray-800 font-medium">${eleve.nom} (${eleve.matricule})</div>
                        <div class="flex-1 flex justify-end space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="status-${eleve.matricule}" value="present" class="form-radio text-accent-green" ${currentStatus === 'present' ? 'checked' : ''}>
                                <span class="ml-2 text-green-700">Pr√©sent</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="status-${eleve.matricule}" value="absent" class="form-radio text-accent-red" ${currentStatus === 'absent' ? 'checked' : ''}>
                                <span class="ml-2 text-red-700">Absent</span>
                            </label>
                        </div>
                    </div>
                `;
      });
    }

    // NOUVEAU: Pr√©-remplir le formulaire de devoir
    window.remplirFormDevoir = matricule => {
      devoirsForm.reset();
      populateMatieresSelect(devoirMatiereSelect); // Assurez-vous que les mati√®res sont charg√©es
      document.getElementById("devoir-matricule").value = matricule;
      devoirsFormEl.classList.remove("hidden");
      formEl.classList.add("hidden");
      notesFormEl.classList.add("hidden");
      presencesFormEl.classList.add("hidden");
      scolariteFormEl.classList.add("hidden");
      devoirsFormEl.scrollIntoView({ behavior: "smooth" });
    };

    // NOUVEAU: Pr√©-remplir le formulaire de scolarit√©
    window.remplirFormScolarite = matricule => {
      scolariteForm.reset();
      const eleve = getEleves().find(e => e.matricule === matricule);
      if (!eleve) {
        show("√âl√®ve non trouv√©", "red");
        return;
      }
      scolariteMatriculeInput.value = matricule;
      scolariteTotalDuInput.value = eleve.totalFeesDue || ""; // Afficher le montant total d√ª actuel
      scolariteFormEl.classList.remove("hidden");
      formEl.classList.add("hidden");
      notesFormEl.classList.add("hidden");
      presencesFormEl.classList.add("hidden");
      devoirsFormEl.classList.add("hidden");
      scolariteFormEl.scrollIntoView({ behavior: "smooth" });
    };

    // Affichage tableau
    function render() {
      const data = getEleves();
      const s = normalize(document.getElementById("search-eleves").value);
      const filtreClasse = normalize(document.getElementById("filter-classe").value);
      const filtreStatut = normalize(document.getElementById("filter-statut").value);
      const filtreSexe = normalize(document.getElementById("filter-sexe").value);

      const filtres = data.filter(e =>
        (!s || normalize(e.nom).includes(s) || normalize(e.matricule).includes(s)) &&
        (!filtreClasse || normalize(e.classe) === filtreClasse) &&
        (!filtreStatut || normalize(e.statut) === filtreStatut) &&
        (!filtreSexe || normalize(e.sexe) === filtreSexe)
      );

      tbody.innerHTML = filtres.length === 0 ? `<tr><td colspan="9" class="text-center py-4 text-gray-500">Aucun √©l√®ve trouv√©.</td></tr>` :
        filtres.map((e, i) => `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-2 px-4">${i + 1}</td>
                        <td class="py-2 px-4">${e.nom}</td>
                        <td class="py-2 px-4">${e.sexe}</td>
                        <td class="py-2 px-4">${e.dateNaissance}</td>
                        <td class="py-2 px-4">${e.filiation}</td>
                        <td class="py-2 px-4">${e.matricule}</td>
                        <td class="py-2 px-4">${e.classe}</td>
                        <td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ${e.statut === 'present' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${e.statut === 'present' ? 'Pr√©sent' : 'Absent'}</span></td>
                        <td class="py-2 px-4 flex space-x-2">
                            <button onclick="view(${i})" class="text-xs bg-accent-blue hover:bg-accent-blue-dark text-white px-2 py-1 rounded shadow-sm">Voir</button>
                            <button onclick="edit(${i})" class="text-xs bg-accent-green hover:bg-accent-green-dark text-white px-2 py-1 rounded shadow-sm">Modif</button>
                            <button onclick="supprimer(${i})" class="text-xs bg-accent-red hover:bg-accent-red-dark text-white px-2 py-1 rounded shadow-sm">Supp</button>
                        </td>
                    </tr>
                `).join("");
    }

    // Affichage messages
    const show = (txt, color = "green") => {
      messageBox.textContent = txt;
      messageBox.className = `mb-4 px-4 py-3 rounded text-sm font-medium ${color === 'green' ? 'bg-green-100 text-green-700' :
        color === 'red' ? 'bg-red-100 text-red-700' :
          'bg-gray-100 text-gray-700'
        }`;
      messageBox.classList.remove("hidden");
      setTimeout(() => messageBox.classList.add("hidden"), 3000);
    };

    // Fonction pour calculer le taux de pr√©sence
    function calculateAttendanceRate(attendanceRecords) {
      if (!attendanceRecords || attendanceRecords.length === 0) {
        return { rate: 0, presentCount: 0, totalCount: 0 };
      }
      const totalDays = attendanceRecords.length;
      const presentDays = attendanceRecords.filter(record => record.status === 'present').length;
      const rate = (presentDays / totalDays) * 100;
      return { rate: rate.toFixed(2), presentCount: presentDays, totalCount: totalDays };
    }

    // Affichage fiche √©l√®ve (MISE √Ä JOUR avec l'historique des notes et de pr√©sence)
    window.view = i => {
      const e = getEleves()[i];
      const historiqueNotes = e.historiqueNotes || [];
      const attendanceRecords = e.attendanceRecords || [];
      const homeworks = e.homeworks || []; // NOUVEAU
      const payments = e.payments || []; // NOUVEAU
      const matieresConfig = getMatieres();

      let historiqueNotesHtml = '';
      if (historiqueNotes.length > 0) {
        historiqueNotesHtml = historiqueNotes.map(evaluation => {
          let notesDetailHtml = '';
          matieresConfig.forEach(matiere => {
            const normalizedMatiere = normalize(matiere);
            const note = evaluation.notesMatiere[normalizedMatiere] !== undefined ? evaluation.notesMatiere[normalizedMatiere] : 'N/A';
            notesDetailHtml += `<div><strong>${matiere} :</strong> ${note}</div>`;
          });

          return `
                        <div class="border border-gray-200 p-3 rounded-md mb-3 bg-white">
                            <h5 class="font-semibold text-primary-blue mb-2">√âvaluation : ${evaluation.periode} (${evaluation.dateEvaluation})</h5>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm mb-2">
                                ${notesDetailHtml}
                            </div>
                            <div class="text-right">
                                <strong>Moyenne :</strong> <span class="font-bold text-lg ${evaluation.moyennePeriode >= 10 ? 'text-green-600' : 'text-red-600'}">${evaluation.moyennePeriode.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
        }).join('');
      } else {
        historiqueNotesHtml = '<p class="text-gray-500">Aucune note enregistr√©e pour cet √©l√®ve.</p>';
      }

      const attendanceRate = calculateAttendanceRate(attendanceRecords);
      let historiquePresenceHtml = `
                <p class="mb-2"><strong>Taux de pr√©sence :</strong> <span class="font-bold text-lg ${attendanceRate.rate >= 80 ? 'text-green-600' : 'text-red-600'}">${attendanceRate.rate}%</span> (${attendanceRate.presentCount} jours sur ${attendanceRate.totalCount})</p>
                <div class="max-h-48 overflow-y-auto border border-gray-200 rounded p-2 bg-white">
            `;
      if (attendanceRecords.length > 0) {
        const sortedRecords = [...attendanceRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
        historiquePresenceHtml += sortedRecords.map(record => `
                    <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0">
                        <span>${record.date}</span>
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${record.status === 'present' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${record.status === 'present' ? 'Pr√©sent' : 'Absent'}
                        </span>
                    </div>
                `).join('');
      } else {
        historiquePresenceHtml += '<p class="text-gray-500">Aucun enregistrement de pr√©sence.</p>';
      }
      historiquePresenceHtml += '</div>';

      // NOUVEAU: HTML pour l'historique des devoirs
      let historiqueDevoirsHtml = `
                <div class="max-h-48 overflow-y-auto border border-gray-200 rounded p-2 bg-white">
            `;
      if (homeworks.length > 0) {
        const sortedHomeworks = [...homeworks].sort((a, b) => new Date(b.dateAssignation) - new Date(a.dateAssignation));
        historiqueDevoirsHtml += sortedHomeworks.map(hw => `
                    <div class="py-1 border-b border-gray-100 last:border-b-0">
                        <p><strong>Mati√®re:</strong> ${hw.matiere}</p>
                        <p><strong>Description:</strong> ${hw.description}</p>
                        <p><strong>Assign√© le:</strong> ${hw.dateAssignation} - <strong>Remis le:</strong> ${hw.dateRemise || 'N/A'}</p>
                        <p><strong>Statut:</strong> <span class="px-2 py-0.5 rounded-full text-xs font-semibold 
                            ${hw.statut === 'fait' ? 'bg-green-100 text-green-800' : hw.statut === 'en retard' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${hw.statut}
                        </span></p>
                    </div>
                `).join('');
      } else {
        historiqueDevoirsHtml += '<p class="text-gray-500">Aucun devoir enregistr√© pour cet √©l√®ve.</p>';
      }
      historiqueDevoirsHtml += '</div>';

      // NOUVEAU: HTML pour les frais de scolarit√©
      let scolariteHtml = `
                <p class="mb-2"><strong>Total d√ª :</strong> <span class="font-bold text-lg">${e.totalFeesDue || 0} GNF</span></p>
                <p class="mb-2"><strong>Solde restant :</strong> <span class="font-bold text-lg ${e.balanceDue <= 0 ? 'text-green-600' : 'text-red-600'}">${e.balanceDue || 0} GNF</span></p>
                <h5 class="font-semibold text-primary-blue mt-4 mb-2">Historique des paiements :</h5>
                <div class="max-h-48 overflow-y-auto border border-gray-200 rounded p-2 bg-white">
            `;
      if (payments.length > 0) {
        const sortedPayments = [...payments].sort((a, b) => new Date(b.date) - new Date(a.date));
        scolariteHtml += sortedPayments.map(p => `
                    <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0">
                        <span>${p.date} - ${p.description || 'Paiement'}</span>
                        <span class="font-semibold text-green-700">${p.montant} GNF</span>
                    </div>
                `).join('');
      } else {
        scolariteHtml += '<p class="text-gray-500">Aucun paiement enregistr√©.</p>';
      }
      scolariteHtml += '</div>';


      // G√©n√©ration dynamique du HTML pour la fiche
      ficheContenu.innerHTML = `
                <div class="bg-gray-50 p-4 rounded shadow-inner mb-4 flex flex-col md:flex-row items-start md:items-center">
                    ${e.photo ? `<img src="${e.photo}" alt="Photo de l'√©l√®ve" class="w-24 h-24 object-cover rounded-full mr-4 mb-4 md:mb-0 border-2 border-primary-blue" />` : `<div class="w-24 h-24 rounded-full mr-4 mb-4 md:mb-0 border-2 border-gray-300 bg-gray-200 flex items-center justify-center text-gray-500 text-3xl">üë§</div>`}
                    <div>
                        <h4 class="font-semibold mb-3 text-primary-blue">üìå Infos g√©n√©rales</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div><strong>Nom :</strong> ${e.nom}</div>
                            <div><strong>Sexe :</strong> ${e.sexe === 'M' ? 'Masculin' : 'F√©minin'}</div>
                            <div><strong>Naissance :</strong> ${e.dateNaissance}</div>
                            <div><strong>Filiation :</strong> ${e.filiation}</div>
                            <div><strong>Matricule :</strong> ${e.matricule}</div>
                            <div><strong>Classe :</strong> ${e.classe}</div>
                            <div><strong>Statut :</strong> <span class="px-2 py-1 rounded-full text-xs font-semibold ${e.statut === 'present' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${e.statut === 'present' ? 'Pr√©sent' : 'Absent'}</span></div>
                             <div><strong>Date d'inscription :</strong> ${e.dateInscription || 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded shadow-inner mb-4">
                    <h4 class="font-semibold mb-3 text-primary-blue">üìû Coordonn√©es</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div><strong>Adresse :</strong> ${e.adresse || 'N/A'}</div>
                        <div><strong>T√©l√©phone :</strong> ${e.telephone || 'N/A'}</div>
                        <div><strong>Email :</strong> ${e.email || 'N/A'}</div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded shadow-inner mb-4">
                    <h4 class="font-semibold mb-3 text-primary-blue">‚úÖ Pr√©sences</h4>
                    ${historiquePresenceHtml}
                </div>

                <div class="bg-gray-50 p-4 rounded shadow-inner mb-4">
                    <h4 class="font-semibold mb-3 text-primary-blue">üìö Devoirs</h4>
                    ${historiqueDevoirsHtml}
                    <button onclick="remplirFormDevoir('${e.matricule}')" class="mt-4 bg-accent-purple hover:bg-accent-purple-dark text-white px-4 py-2 rounded shadow-md">üìù Ajouter un devoir</button>
                </div>

                <div class="bg-gray-50 p-4 rounded shadow-inner mb-4">
                    <h4 class="font-semibold mb-3 text-primary-blue">üí∏ Scolarit√©</h4>
                    ${scolariteHtml}
                    <button onclick="remplirFormScolarite('${e.matricule}')" class="mt-4 bg-accent-orange hover:bg-accent-orange-dark text-white px-4 py-2 rounded shadow-md">üí≥ G√©rer les paiements</button>
                </div>

                <div class="bg-gray-50 p-4 rounded shadow-inner">
                    <h4 class="font-semibold mb-3 text-primary-blue">üìò Historique des Notes</h4>
                    <div class="space-y-4">
                        ${historiqueNotesHtml}
                    </div>
                    <button onclick="remplirFormNotes('${e.matricule}')" class="mt-4 bg-accent-blue hover:bg-accent-blue-dark text-white px-4 py-2 rounded shadow-md">‚úèÔ∏è Ajouter une nouvelle √©valuation</button>
                </div>
            `;
      ficheEl.classList.remove("hidden");
      ficheEl.scrollIntoView({ behavior: "smooth" });
    };

    // Pr√©remplir le formulaire de notes (pour AJOUTER une nouvelle √©valuation)
    window.remplirFormNotes = matricule => {
      const e = getEleves().find(e => e.matricule === matricule);
      if (!e) return show("√âl√®ve introuvable", "red");
      document.getElementById("note-matricule").value = matricule;
      document.getElementById("periode-evaluation").value = "";
      document.getElementById("date-evaluation").value = "";

      generateNoteInputs();

      const matieres = getMatieres();
      matieres.forEach(matiere => {
        const inputId = `note-${normalize(matiere)}`;
        const noteInput = document.getElementById(inputId);
        if (noteInput) {
          noteInput.value = "";
        }
      });

      notesFormEl.classList.remove("hidden");
      // Cacher les autres formulaires
      formEl.classList.add("hidden");
      presencesFormEl.classList.add("hidden");
      devoirsFormEl.classList.add("hidden");
      scolariteFormEl.classList.add("hidden");
      notesFormEl.scrollIntoView({ behavior: "smooth" });
    };

    // Fonction pour g√©n√©rer les champs d'entr√©e de notes dynamiquement
    function generateNoteInputs() {
      const matieres = getMatieres();
      champsNotesDynamiques.innerHTML = '';
      if (matieres.length === 0) {
        champsNotesDynamiques.innerHTML = '<p class="col-span-full text-red-600">Aucune mati√®re configur√©e. Veuillez ajouter des mati√®res pour saisir des notes.</p>';
        notesForm.querySelector('button[type="submit"]').disabled = true;
      } else {
        notesForm.querySelector('button[type="submit"]').disabled = false;
        matieres.forEach(matiere => {
          const inputId = `note-${normalize(matiere)}`;
          champsNotesDynamiques.innerHTML += `
                        <input type="number" id="${inputId}" placeholder="Note en ${matiere}" min="0" max="20"
                            class="border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue" />
                    `;
        });
      }
    }

    // NOUVEAU: Fonction pour populer le select des mati√®res
    function populateMatieresSelect(selectElement) {
      const matieres = getMatieres();
      selectElement.innerHTML = '<option value="">S√©lectionner la mati√®re</option>';
      matieres.forEach(m => {
        const option = document.createElement("option");
        option.value = m;
        option.textContent = m;
        selectElement.appendChild(option);
      });
    }


    // Modifier / supprimer
    window.edit = i => {
      const e = getEleves()[i];
      document.getElementById("nom").value = e.nom;
      document.getElementById("sexe").value = e.sexe;
      document.getElementById("naissance").value = e.dateNaissance;
      document.getElementById("filiation").value = e.filiation;
      document.getElementById("matricule").value = e.matricule;
      document.getElementById("classe").value = e.classe;
      document.getElementById("statut").value = e.statut;

      document.getElementById("dateInscription").value = e.dateInscription || '';
      document.getElementById("adresse").value = e.adresse || '';
      document.getElementById("telephone").value = e.telephone || '';
      document.getElementById("email").value = e.email || '';

      if (e.photo) {
        previewPhoto.src = e.photo;
        previewPhoto.classList.remove('hidden');
      } else {
        previewPhoto.src = '';
        previewPhoto.classList.add('hidden');
      }

      editIndex = i;
      document.getElementById("form-titre").textContent = "Modifier un √©l√®ve";
      formEl.classList.remove("hidden");
      // Cacher les autres formulaires
      notesFormEl.classList.add("hidden");
      presencesFormEl.classList.add("hidden");
      devoirsFormEl.classList.add("hidden");
      scolariteFormEl.classList.add("hidden");
      formEl.scrollIntoView({ behavior: "smooth" });
    };

    window.supprimer = i => {
      const data = getEleves();
      if (confirm(`Supprimer l'√©l√®ve ${data[i].nom} (${data[i].matricule}) ? Cette action est irr√©versible.`)) {
        data.splice(i, 1);
        setEleves(data);
        render();
        show("√âl√®ve supprim√© avec succ√®s", "green");
        ficheEl.classList.add("hidden");
      }
    };

    // Listeners pour les boutons Ajouter/Annuler
    document.getElementById("btn-ajouter").addEventListener("click", () => {
      form.reset();
      photoInput.value = '';
      previewPhoto.classList.add('hidden');
      document.getElementById("form-titre").textContent = "Ajouter ou modifier un √©l√®ve";
      formEl.classList.remove("hidden");
      // Cacher les autres formulaires
      notesFormEl.classList.add("hidden");
      presencesFormEl.classList.add("hidden");
      devoirsFormEl.classList.add("hidden");
      scolariteFormEl.classList.add("hidden");
      editIndex = null;
      formEl.scrollIntoView({ behavior: "smooth" });
    });

    document.getElementById("btn-annuler").addEventListener("click", () => {
      formEl.classList.add("hidden");
      form.reset();
      photoInput.value = '';
      previewPhoto.classList.add('hidden');
      editIndex = null;
    });

    document.getElementById("btn-ajouter-notes").addEventListener("click", () => {
      notesForm.reset();
      generateNoteInputs();
      document.getElementById("note-matricule").value = "";
      document.getElementById("periode-evaluation").value = "";
      document.getElementById("date-evaluation").value = "";
      notesFormEl.classList.remove("hidden");
      // Cacher les autres formulaires
      formEl.classList.add("hidden");
      presencesFormEl.classList.add("hidden");
      devoirsFormEl.classList.add("hidden");
      scolariteFormEl.classList.add("hidden");
      notesFormEl.scrollIntoView({ behavior: "smooth" });
    });

    document.getElementById("btn-annuler-notes").addEventListener("click", () => {
      notesFormEl.classList.add("hidden");
      notesForm.reset();
    });

    // Listeners pour le formulaire de pr√©sence
    document.getElementById("btn-enregistrer-presences").addEventListener("click", () => {
      presencesForm.reset();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("date-presence").value = today;
      populateAttendanceFormElements();
      presencesFormEl.classList.remove("hidden");
      // Cacher les autres formulaires
      formEl.classList.add("hidden");
      notesFormEl.classList.add("hidden");
      devoirsFormEl.classList.add("hidden");
      scolariteFormEl.classList.add("hidden");
      presencesFormEl.scrollIntoView({ behavior: "smooth" });
    });

    document.getElementById("btn-annuler-presences").addEventListener("click", () => {
      presencesFormEl.classList.add("hidden");
      presencesForm.reset();
    });

    // NOUVEAU: Listeners pour le formulaire de devoirs
    document.getElementById("btn-suivre-devoirs").addEventListener("click", () => {
      devoirsForm.reset();
      populateMatieresSelect(devoirMatiereSelect); // Charger les mati√®res
      document.getElementById("devoir-matricule").value = ""; // Vider le matricule
      devoirsFormEl.classList.remove("hidden");
      // Cacher les autres formulaires
      formEl.classList.add("hidden");
      notesFormEl.classList.add("hidden");
      presencesFormEl.classList.add("hidden");
      scolariteFormEl.classList.add("hidden");
      devoirsFormEl.scrollIntoView({ behavior: "smooth" });
    });
    document.getElementById("btn-annuler-devoirs").addEventListener("click", () => {
      devoirsFormEl.classList.add("hidden");
      devoirsForm.reset();
    });

    // NOUVEAU: Listeners pour le formulaire de scolarit√©
    document.getElementById("btn-gerer-scolarite").addEventListener("click", () => {
      scolariteForm.reset();
      document.getElementById("scolarite-matricule").value = ""; // Vider le matricule
      document.getElementById("scolarite-total-du").value = ""; // Vider le montant total d√ª
      scolariteFormEl.classList.remove("hidden");
      // Cacher les autres formulaires
      formEl.classList.add("hidden");
      notesFormEl.classList.add("hidden");
      presencesFormEl.classList.add("hidden");
      devoirsFormEl.classList.add("hidden");
      scolariteFormEl.scrollIntoView({ behavior: "smooth" });
    });
    document.getElementById("btn-annuler-scolarite").addEventListener("click", () => {
      scolariteFormEl.classList.add("hidden");
      scolariteForm.reset();
    });


    document.getElementById("btn-fermer-fiche").addEventListener("click", () => {
      ficheEl.classList.add("hidden");
    });


    // Initialisation du s√©lecteur de classe
    function populateClassesSelect() {
      const classes = getClasses();
      const selectClasse = document.getElementById("classe");
      const filterClasse = document.getElementById("filter-classe");
      const filterClassePresence = document.getElementById("filter-classe-presence");

      selectClasse.innerHTML = '<option value="">S√©lectionner une classe</option>';
      filterClasse.innerHTML = '<option value="">Toutes les classes</option>';
      filterClassePresence.innerHTML = '<option value="">Toutes les classes</option>';

      classes.forEach(c => {
        const option = document.createElement("option");
        option.value = c.nom;
        option.textContent = c.nom;
        selectClasse.appendChild(option);

        const filterOption = option.cloneNode(true);
        filterClasse.appendChild(filterOption);

        const filterPresenceOption = option.cloneNode(true);
        filterClassePresence.appendChild(filterPresenceOption);
      });
    }


    // Filtres et recherche
    document.getElementById("search-eleves").addEventListener("input", render);
    document.getElementById("filter-classe").addEventListener("change", render);
    document.getElementById("filter-statut").addEventListener("change", render);
    document.getElementById("filter-sexe").addEventListener("change", render);

    document.getElementById("btn-reset-filtres").addEventListener("click", () => {
      document.getElementById("search-eleves").value = "";
      document.getElementById("filter-classe").value = "";
      document.getElementById("filter-statut").value = "";
      document.getElementById("filter-sexe").value = "";
      render();
    });

    // Toggle sidebar et dropdown user
    menuToggle.addEventListener("click", () => {
      mainSidebar.classList.toggle("-translate-x-full");
      sidebarOverlay.classList.toggle("hidden");
      sidebarOverlay.classList.toggle("opacity-0");
      setTimeout(() => sidebarOverlay.classList.toggle("opacity-50"), 10);
    });

    sidebarOverlay.addEventListener("click", () => {
      mainSidebar.classList.add("-translate-x-full");
      sidebarOverlay.classList.add("opacity-0");
      setTimeout(() => sidebarOverlay.classList.add("hidden"), 300);
    });

    userToggle.addEventListener("click", () => {
      userDropdown.classList.toggle("hidden");
    });

    document.addEventListener("click", (event) => {
      if (!userToggle.contains(event.target) && !userDropdown.contains(event.target)) {
        userDropdown.classList.add("hidden");
      }
    });

    // Effet de d√©filement du header
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) {
        mainHeader.classList.add('scrolled-header');
      } else {
        mainHeader.classList.remove('scrolled-header');
      }
    });


    // Initialisation
    document.addEventListener("DOMContentLoaded", () => {
      populateClassesSelect();
      generateNoteInputs(); // For notes form
      populateMatieresSelect(devoirMatiereSelect); // For homework form
      render();
    });
  </script>
</body>

</html>